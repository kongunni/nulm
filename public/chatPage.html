<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>nulm. </title>
    <link rel="icon" type="image/png" href="images/nulm_icon.png">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/fonts.css">
</head>
<body>
    <div id="main" style="overflow-x: hidden;">
        <header class="nav-container" style="width: 100%;">
            <div class="box nav-logo-container logo" >
                <a href="index.html">Nulm.</a>
            </div>
            <nav class="box nav-menu-container nav">
                <a href="index.html">HOME</a>
                <a href="aboutPage.html">ABOUT</a>
                <a href="chatPage.html">CHAT</a>
            </nav>
            <div class="box nav-contact-container contact-button">
                <button id="contactBtn" onclick="goToContactPage()">CONCTACT</button>
            </div>
            <div class="hamburger-menu" onclick="toggleMenu()">â˜°</div>
        </header>

         <!-- full screen navigation -->
         <div class="full-screen-nav" id="fullScreenNav">
            <div class="full-screen-nav-content">
                <div class="logo"> nulm. </div>
                <a href="index.html">HOME</a>
                <a href="aboutPage.html">ABOUT</a>
                <a href="chatPage.html">CHAT</a>
                <a href="contactPage.html">CONTACT</a>
            </div>
            <div class="full-screen-nav-close-btn" onclick="toggleMenu()">âœ–</div>
        </div>
        
        <!-- í™”ë©´ ì˜ì—­ -->
        <div class="chat-container">
            <div class="chat-button-container" id="chatButtonContainer">
                <div class="enter-section">
                    <img id="coverImg" src="images/cover-chatPage.jpg" alt="">
                    <button id="enterBtn"> >> enter << </button>
                </div>
            </div>
            <div class="chat-section" id="chatSection">
                <div class="chat-box" id="chatBox" style="display: none;">
                    <div class="chat-header-container">
                        <div class="chat-header" id="chatHeader"></div>
                        <div class="chat-btn">
                            <button id="restartBtn" class="chat-header-btn" type="button">â†»</button>
                            <button id="exitBtn" class="chat-header-btn" type="button" style="color: #e65729;"> X </button>
                        </div>
                    </div>

                    <!--report modal-->
                    <div id="reportModal" class="report-container" style="display: none;">
                        <div id="modalHeader">
                            <!-- <h1>report</h1> -->
                        </div>
                        <div id="modal-section">
                            <form id="reportForm">
                                <label><input type="checkbox" name="reason" value="ìŠ¤íŒ¸">ìŠ¤     íŒ¸</label>
                                <label><input type="checkbox" name="reason" value="ë¹„ì†ì–´">ë¹„ ì† ì–´</label>
                                <label><input type="checkbox" name="reason" value="ê¸ˆì „ìš”êµ¬">ê¸ˆì „ìš”êµ¬</label>
                                <label><input type="checkbox" name="reason" value="ê¸°íƒ€" >ê¸°     íƒ€</label>
                                <div class="reportBtn">
                                    <button id="reportSubmitBtn" class="report-form-btn" type="button" onclick="submitReport()">report</button>
                                    <button id="reportCancelBtn" class="report-form-btn" type="button" onclick="closeReportModal()">cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="chat-framer">
                         <!-- ê³µì§€-->
                        <div class="chat-notification-container" id="notificationBox">
                            <div class="scrolling-text" id="scrollingText">
                                âœ¢ ë°±ê·¸ë¼ìš´ë“œ ì „í™˜ ìƒíƒœì—ì„œ 3ì‹œê°„ ê²½ê³¼ì‹œ,
                                ìë™ìœ¼ë¡œ ì—°ê²°ì´ ì¢…ë£Œë  ìˆ˜ ìˆìŒì„ ì•Œë¦½ë‹ˆë‹¤.
                            </div>
                        </div>
                        <div class="chat-message" id="messages"></div>
                        <div class="input-container">
                            <div id="inputBox" class="input-box">
                                <input id="message" class="input-msg" type="text"  autocomplete="off">
                                <button id="emoji-btn">
                                    <img src="images/icon_emoji.PNG" alt="" width="20px">
                                </button>
                                <button id="send">send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!--chat container-->

        <!-- footer ì˜ì—­ -->
        <footer class="footer">
            <div class="footer-content">
                <p>Nulm.</p>
                <p>GASAN, GEUMCHEON, SEOUL, KOREA</p>
                <p>YI JI YEONG</p>
                <p>+82 10 5072 3383</p>
                <p>KONGUNNI821@GMAIL.COM</p>
            </div>
        </footer>

    </div> <!--main-->

<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
<script src="socket.io/socket.io.js"></script> <!-- socket -->
<script>
    let socket;
    let roomId; 
    let partnerNickname;

    // hamburger menu
    function toggleMenu() {
        const fullScreenNav = document.getElementById('fullScreenNav');
        fullScreenNav.classList.toggle('open');
    }

    // go to contact
    function goToContactPage(){
        // window.location.href='contactPage.html';
    }


    // modal reset
    function resetReportModal() {
        const reportForm = document.getElementById('reportForm');
        if (reportForm) {
            const checkboxes = reportForm.querySelectorAll('input[name="reason"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
    }


    // modal open
    function openReportModal() {
        const reportModal  = document.getElementById('reportModal');
        reportModal.style.display = 'flex';
    }

    // modal close
    function closeReportModal() {
        const reportModal  = document.getElementById('reportModal');
        reportModal.style.display ='none';
        resetReportModal();
    }


    //report submit
     function submitReport() {
            const reportForm = document.getElementById('reportForm');
            const reasons = Array.from(reportForm.querySelectorAll('input[name="reason"]:checked')).map(input => input.value);
            
            if(reasons.length === 0) {
                alert('ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”. ');
                return;
            }

            console.log('roomId: ', roomId, 'partner: ', partnerNickname, '[IP:', partnerIP , ']', 'reason: ', reasons);
            
            if (!roomId || !partnerNickname || !partnerIP) {
                alert('ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”. ');
                return;
            }

            fetch('/chat/report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reasons,
                    roomId,
                    partnerNickname,
                    partnerIP // reported: ì‹ ê³ ëŒ€ìƒ
                    // reporterId: socket.id //ì‹ ê³ ì socketId
                })
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                return response.json();
            })
            .then(data => {
                alert(data.message); // ì„œë²„ ì‘ë‹µ ì²˜ë¦¬
                console.log('[client] server repsponse data: ', data);
                if (socket && roomId) {
                    console.log('[client] Calling socket.emit for report-disconnected...');
                    socket.emit('report-disconnected', { roomId });
                }
                closeReportModal();
            })
            .catch(err => {
                console.error('Error reporting user:', err);
                alert('ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(()=>{
                resetReportModal();
            });
        }



    
    /* ì±„íŒ… í´ë¼ì´ì–¸íŠ¸ */
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();

        const chatButtonContainer = document.getElementById('chatButtonContainer'); 
        const chatBox = document.getElementById('chatBox');
        const enterBtn = document.getElementById('enterBtn');
        const chatHeader = document.getElementById('chatHeader');
        const sendButton = document.getElementById('send');
        const mediaQuery = window.matchMedia('(max-width: 430px)'); //ëª¨ë°”ì¼ê·œê²©
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('message');
        const inputBox = document.getElementById('inputBox');

        let myNickname = ''; // ë‚´ ë‹‰ë„¤ì„ ì €ì¥ ë³€ìˆ˜
        let chatStarted = false; // ì±„íŒ… ì‹œì‘ìƒíƒœ
        let isProcessing = false; // ì¤‘ë³µ ì…ë ¥ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸ ë³€ìˆ˜

        if (!messageInput) {
            console.error('<input id="message"> not found after DOMContentLoaded');
        }

        // ì‚¬ìš©ìê°€ enter í´ë¦­ì‹œ ì±„íŒ…ì°½ í™”ë©´ì— ë‚˜íƒ€ë‚´ê¸°
         enterBtn.addEventListener('click', function() {
            if(!chatStarted) {
                chatBox.style.display = 'flex';
                chatButtonContainer.style.display = 'none';
                chatStarted = true;
                socket.emit('enter-state');
            }
        });

        // session ì•¡ì…˜ ì²˜ë¦¬
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('[client] Tab returned to foreground. Reset session.');
                socket.emit('session-action', 'reset');
            } else if (document.visibilityState === 'hidden') {
                console.log('[client] Tab moved to background.');
                socket.emit('session-action', 'background');
            }
        });

        // chat-notification
        const notificationBox = document.getElementById('notificationBox');
        setTimeout( ()=> {
            notificationBox.style.display ='none';
        }, 15500 ); 


        /* 
        * emoji 
        */
        const emojiBtn = document.getElementById('emoji-btn');
        const inputElement = document.getElementById('message');

        const pickerOptions = {
            onEmojiSelect: (emoji) => {
                //const input = document.getElementById('message'); 
                if(inputElement) {
                    inputElement.value += emoji.native;
                    inputElement.focus();
                } else {
                    console.error('<input> not found');
                }
            },
        };
       
        const picker = new EmojiMart.Picker(pickerOptions);
        picker.style.display = 'none';
        picker.style.position = 'absolute';
        picker.style.width = '360px';
        picker.style.maxHeight = '300px';
        picker.style.overflowX = 'hidden';
        picker.style.overflowY = 'auto';
        picker.style.zIndex = '9999';
        document.body.appendChild(picker);

        // Picker ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updatePickerPosition() {
            const inputContainer = document.querySelector('.input-container');
            const inputRect = inputContainer.getBoundingClientRect();
            picker.style.top = `${window.scrollY + inputRect.top - picker.offsetHeight - 10}px`; // 10px ì—¬ë°±
            picker.style.left = `${inputRect.left + inputRect.width / 2 - picker.offsetWidth / 2}px`;
        }

        // Picker ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function hidePicker() {
            if (picker && picker.style.display === 'block') {
                picker.style.display = 'none';
            }
        }
        
        function togglePicker() {
            if (picker.style.display === 'none' || picker.style.display === '') {
                picker.style.display = 'block';
                updatePickerPosition();
            } else {
                hidePicker();
            }
        }

        // ì´ëª¨ì§€ í´ë¦­ì‹œ í´ë¦­ìœ„ì¹˜ì— ì˜¤ê²Œ ì²˜ë¦¬
       emojiBtn.addEventListener('click', (event) => {
            if (picker.style.display === 'none' || picker.style.display === '') {
                picker.style.display = 'block';
                updatePickerPosition();
            } else {
                hidePicker();
            }
        });
        //emojiBtn.addEventListener('click', togglePicker);
        emojiBtn.addEventListener('touchstart', (evnet) => {
            event.preventDefault();
            togglePicker();
        }, { passive: false });

        
        // ë‹¤ë¥¸ ì˜ì—­ í´ë¦­ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬
        document.addEventListener('click', (event) => {
            const isClickInsidePicker = picker.contains(event.target);
            const isClickOnEmojiButton = emojiBtn.contains(event.target);
            if (!isClickInsidePicker && !isClickOnEmojiButton) {
                hidePicker();
            }
        });

        picker.addEventListener('click', (evnet) => {
            evnet.stopPropagation();
            console.log(`Selected emoji: ${emoji.native}`);
        });

        // send button
        function updateSendBtn(e) {
            if (e.matches) {
                sendButton.innerHTML = '<img src="images/sendBtn.png">';       
            } else {
                sendButton.textContent = 'send';
            }
        }
        updateSendBtn(mediaQuery);
        mediaQuery.addEventListener('change', updateSendBtn);


        /*
        *   ì±„íŒ…
        */ 
        chatBox.style.display = 'none';
        enterBtn.style.display = 'block';

        

        // ì„œë²„ì—ì„œ ë‹‰ë„¤ì„ ì´ˆê¸°í™” ì´ë²¤íŠ¸ ì¶”ê°€
        socket.on('set-nickname', (nickname) => {
            myNickname = nickname;
            console.log(`[client] í˜„ì¬ ì ‘ì†ì: ${myNickname}`);
        });


        // session - expired
        socket.on('session-expired', (data) => {
            // ì„¸ì…˜ ë§Œë£Œ ì‹œ UI ì´ˆê¸°í™”
            document.getElementById('chatBox').style.display = 'none';
            document.getElementById('chatButtonContainer').style.display = 'flex';
            document.getElementById('messages').innerHTML = '';

            // window.location.href= 'chatPage.html';
                // 100ms ë”œë ˆì´ í›„ í˜ì´ì§€ ì´ë™
            setTimeout(() => {
                window.location.replace('chatPage.html');
                alert(data.message);
            }, 50);
        });

       // message êµ¬ë¶„í•˜ì—¬ ë‚˜íƒ€ë‚´ê¸° 
        function appendMessages(message, messageType) {
            const messageContainer = document.getElementById('messages');
            const newMessage = document.createElement('div');
            
            newMessage.className = messageType === 'system' ? 'system-message'
                                : messageType === 'sender' ? 'chat-message sender'
                                                            : 'chat-message receiver';
            newMessage.textContent = message;
            messageContainer.appendChild(newMessage);
            messageContainer.scrollTop = messageContainer.scrollHeight;

            if (messageType === 'sender') {
                messageInput.value = '';
            }
            //messageInput.value = ''; 
        };

        // send ë©”ì‹œì§€ 
        function sendMessage(){
            const msg = messageInput.value.trim();
            if (msg) {
                socket.emit('chat-message', msg); // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
                messageInput.value = '';
            }
        };

        // ë²„íŠ¼ í´ë¦­ ë˜ëŠ” Enter í‚¤ ì…ë ¥ ì‹œ ë©”ì‹œì§€ ì „ì†¡
        function handleSend(event) {
            if (event.type === 'click' || (event.type === 'keydown' && event.key === 'Enter')) {
                event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€

                if (isProcessing) return; // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
                isProcessing = true;
                sendMessage();

                // 30ms í›„ í”Œë˜ê·¸ ì´ˆê¸°í™” (ì¤‘ë³µ ë°©ì§€ íƒ€ì´ë¨¸)
                setTimeout(() => {
                    messageInput.value = '';
                    isProcessing = false;
                }, 30);
            }
        }

        // ëŒ€ê¸°ì¤‘ì¸ ìœ ì €ì—ê²Œ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì „ì†¡ 
        socket.on ('wait-state', (data) => {
            appendMessages(data.message , data.messageType);
        });

        // ì±„íŒ… ì¤€ë¹„ ì™„ë£Œ ì‹œ ìƒëŒ€ë°© ë‹‰ë„¤ì„ í‘œì‹œ
        socket.on('chat-ready', (data) => {
            // ìƒëŒ€ë°© ì •ë³´ í‘œì‹œ
            const partner = data.users.find(user => user.id !== socket.id);
            roomId= data.roomId;
            partnerNickname = partner.nickname;
            partnerIP = partner.userIP;

            const inputBox = document.getElementById('inputBox');
            if (inputBox) {
                inputBox.style.visibility = 'visible';
                inputBox.style.display = 'flex'; // ì…ë ¥ì°½ í™œì„±í™”
            }
            
            chatHeader.textContent = "connected with: " + partner.nickname;
            // report ë²„íŠ¼ í™”ë©´ì— í‘œì‹œ
            const reportBtn = document.createElement('button');
            reportBtn.id = 'reportBtn';
            reportBtn.className = 'chat-header-btn';
            reportBtn.type = 'button';
            reportBtn.textContent = 'ğŸš¨'; // ë²„íŠ¼ ë‚´ìš©
            reportBtn.onclick = openReportModal; // í´ë¦­ ì‹œ ì‹ ê³  ëª¨ë‹¬ ì—´ê¸°
            chatHeader.appendChild(reportBtn);  // ë‹‰ë„¤ì„ ì˜†ì— ë²„íŠ¼ ì¶”ê°€

            appendMessages(data.message, data.messageType);


        });

        socket.on('warning-message', (data) => {
            appendMessages(data.message, data.messageType);
        });

        // ë©”ì‹œì§€ ìˆ˜ì‹ 
        socket.on('chat-message', (data) => {
            const isSender = data.sender === myNickname; 
            appendMessages(data.message, isSender ? 'sender' : 'receiver');
        });

        // ì±„íŒ… ì¢…ë£Œì‹œ ì²˜ë¦¬
        socket.on('chat-end', (data) => {
            appendMessages(data.message, 'system'); // ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ì•Œë¦¼ í‘œì‹œ
            const chatHeader = document.getElementById('chatHeader');
            if (chatHeader) {
                chatHeader.textContent = ''; // ë‹‰ë„¤ì„ ì œê±°
                console.log('chatHeader content cleared.');
            }
            document.getElementById('inputBox').style.display='none'; // ì…ë ¥ì°½ ë¹„í™œì„±í™”
        });

        // ì„œë²„ ì—°ê²° ì¢…ë£Œ ê°ì§€
        socket.on('disconnect', () => {
            console.log('[client] ì„œë²„ì™€ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
            appendMessages(data.message, 'system');

            // ë‹‰ë„¤ì„ ë° UI ì´ˆê¸°í™”
            const chatHeader = document.getElementById('chatHeader');
            if (chatHeader) {
                chatHeader.textContent = ''; // ë‹‰ë„¤ì„ ì œê±°
            }

            // ì…ë ¥ì°½ ë¹„í™œì„±í™”
            const inputBox = document.getElementById('inputBox');
            if (inputBox) {
                inputBox.style.display = 'none';
            }
        });


        // ìƒëŒ€ë°©ì˜ ìš”ì²­ìœ¼ë¡œ ì±„íŒ… ì¢…ë£Œ
        socket.on('user-disconnect', (data) => {
            appendMessages(data.message, 'system'); // ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ì•Œë¦¼ í‘œì‹œ
            
            const chatHeader = document.getElementById('chatHeader');
            if (chatHeader) {
                chatHeader.textContent = ''; // ë‹‰ë„¤ì„ ì œê±°
                console.log('chatHeader content cleared.');
            }
            document.getElementById('inputBox').style.display='none'; // ì…ë ¥ì°½ ë¹„í™œì„±í™”

        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        sendButton.addEventListener('click', handleSend);
        messageInput.addEventListener('keydown', handleSend);

        // ì±„íŒ… ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ
        document.getElementById('exitBtn').addEventListener('click', () => {
            socket.emit('user-disconnect'); // ì„œë²„ì— ì¢…ë£Œ ìš”ì²­
            document.getElementById('chatBox').style.display = 'none'; // ì±„íŒ…ì°½ ìˆ¨ê¸°ê¸°
            document.getElementById('chatButtonContainer').style.display = 'flex'; // ì´ˆê¸° ìƒíƒœë¡œ ë³µêµ¬
            document.getElementById('messages').innerHTML = '';
       
        });

        // ì¬ì—°ê²° ë²„íŠ¼ í´ë¦­ì‹œ 
        document.getElementById('restartBtn').addEventListener('click', () => {
            socket.emit('restart-connect'); // ì„œë²„ì— ì¬ì—°ê²° ìš”ì²­
            document.getElementById('inputBox').style.display='none'; 
        });
    });
</script>
</body>
</html>