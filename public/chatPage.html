<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>nulm. </title>
    <link rel="icon" type="image/png" href="images/nulm_icon.png">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/fonts.css">
</head>
<body>
    <div id="main" style="overflow-x: hidden;">
        <header class="nav-container" style="width: 100%;">
            <div class="box nav-logo-container logo" >
                <a href="index.html">Nulm.</a>
            </div>
            <nav class="box nav-menu-container nav">
                <a href="index.html">HOME</a>
                <a href="aboutPage.html">ABOUT</a>
                <a href="chatPage.html">CHAT</a>
            </nav>
            <div class="box nav-contact-container contact-button">
                <button id="contactBtn" onclick="goToContactPage()">CONCTACT</button>
            </div>
            <div class="hamburger-menu" onclick="toggleMenu()">‚ò∞</div>
        </header>

         <!-- full screen navigation -->
         <div class="full-screen-nav" id="fullScreenNav">
            <div class="full-screen-nav-content">
                <div class="logo"> nulm. </div>
                <a href="index.html">HOME</a>
                <a href="aboutPage.html">ABOUT</a>
                <a href="chatPage.html">CHAT</a>
                <a href="#">CONTACT</a>
            </div>
            <div class="full-screen-nav-close-btn" onclick="toggleMenu()">‚úñ</div>
        </div>
        
        <!-- ÌôîÎ©¥ ÏòÅÏó≠ -->
        <div class="chat-container">
            <div class="chat-button-container" id="chatButtonContainer">
                <div class="enter-section">
                    <img id="coverImg" src="images/cover-chatPage.jpg" alt="">
                    <button id="enterBtn"> >> enter << </button>
                </div>
            </div>
            <div class="chat-section" id="chatSection">
                <div class="chat-box" id="chatBox" style="display: none;">
                    <div class="chat-header-container">
                        <div class="chat-header" id="chatHeader"></div>
                        <div class="chat-btn">
                            <button id="restartBtn" class="chat-header-btn" type="button">‚Üª</button>
                            <button id="exitBtn" class="chat-header-btn" type="button" style="color: #e65729;"> X </button>
                        </div>
                    </div>

                    <!--report modal-->
                    <div id="reportModal" class="report-container" style="display: none;">
                        <div id="modalHeader">
                            <!-- <h1>report</h1> -->
                        </div>
                        <div id="modal-section">
                            <form id="reportForm">
                                <label><input type="checkbox" name="reason" value="spam">Ïä§     Ìå∏</label>
                                <label><input type="checkbox" name="reason" value="profanity">ÎπÑ ÏÜç Ïñ¥</label>
                                <label><input type="checkbox" name="reason" value="scam">Í∏àÏ†ÑÏöîÍµ¨</label>
                                <label><input type="checkbox" name="reason" value="etc" >Í∏∞     ÌÉÄ</label>
                                <div class="reportBtn">
                                    <button id="reportSubmitBtn" class="report-form-btn" type="button" onclick="submitReport()">report</button>
                                    <button id="reportCancelBtn" class="report-form-btn" type="button" onclick="closeReportModal()">cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="chat-framer">
                         <!-- Í≥µÏßÄ-->
                        <div class="chat-notification-container" id="notificationBox">
                            <div class="scrolling-text" id="scrollingText">
                                ‚ú¢ Î∞±Í∑∏ÎùºÏö¥Îìú Ï†ÑÌôò ÏÉÅÌÉúÏóêÏÑú 3ÏãúÍ∞Ñ Í≤ΩÍ≥ºÏãú,
                                ÏûêÎèôÏúºÎ°ú Ïó∞Í≤∞Ïù¥ Ï¢ÖÎ£åÎê† Ïàò ÏûàÏùåÏùÑ ÏïåÎ¶ΩÎãàÎã§.
                            </div>
                        </div>
                        <div class="chat-message" id="messages"></div>
                        <div class="input-container">
                            <div id="inputBox" class="input-box">
                                <input id="message" class="input-msg" type="text"  autocomplete="off">
                                <button id="emoji-btn">
                                    <img src="images/icon_emoji.PNG" alt="" width="20px">
                                </button>
                                <button id="send">send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!--chat container-->

        <!-- footer ÏòÅÏó≠ -->
        <footer class="footer">
            <div class="footer-content">
                <p>Nulm.</p>
                <p>GASAN, GEUMCHEON, SEOUL, KOREA</p>
                <p>YI JI YEONG</p>
                <p>+82 10 5072 3383</p>
                <p>KONGUNNI821@GMAIL.COM</p>
            </div>
        </footer>

    </div> <!--main-->

<script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
<script src="socket.io/socket.io.js"></script> <!-- socket -->
<script>
    let socket;
    let roomId; 
    let partnerNickname;
    let partner;
    // let parnter;

    // hamburger menu
    function toggleMenu() {
        const fullScreenNav = document.getElementById('fullScreenNav');
        fullScreenNav.classList.toggle('open');
    }

    // go to contact
    function goToContactPage(){
        // window.location.href='contactPage.html';
    }

    // modal reset
    function resetReportModal() {
        const reportForm = document.getElementById('reportForm');
        if (reportForm) {
            const checkboxes = reportForm.querySelectorAll('input[name="reason"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
    }

    // modal open
    function openReportModal() {
        const reportModal  = document.getElementById('reportModal');
        reportModal.style.display = 'flex';
    }

    // modal close
    function closeReportModal() {
        const reportModal  = document.getElementById('reportModal');
        reportModal.style.display ='none';
        resetReportModal();
    }

    // report - submit
    function submitReport() {
        const reportForm = document.getElementById('reportForm');
        const selectedReason = Array.from(reportForm.querySelectorAll('input[name="reason"]:checked')).map(input => input.value);
        
        if (selectedReason.length === 0) {
            alert('Ïã†Í≥† ÏÇ¨Ïú†Î•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.');
            return;
        }

        if (!partner || !partner.id) {
            alert('ÏÉÅÎåÄÎ∞© Ï†ïÎ≥¥Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.');
            return;
        }
        
        const reportData = {
            reporter: { id: socket.id }, // Ïã†Í≥†Ïûê Ï†ïÎ≥¥
            partner: { id: partner.id, userIP: partner.userIP }, // Ïã†Í≥† ÎåÄÏÉÅ Ï†ïÎ≥¥
            reason: selectedReason, // Ïã†Í≥† ÏÇ¨Ïú†
            roomId: roomId // ÌòÑÏû¨ Ï±ÑÌåÖÎ∞© ID
        };

        // Ïã†Í≥† Îç∞Ïù¥ÌÑ∞ ÏÑúÎ≤ÑÏ†ÑÏÜ°
        socket.emit('report-disconnect', reportData);
        
        // ÏÑúÎ≤Ñ ÏùëÎãµ Ï≤òÎ¶¨
        closeReportModal();
    }

    /* Ï±ÑÌåÖ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ */
    document.addEventListener('DOMContentLoaded', function() {
        // socket = io();

        const chatButtonContainer = document.getElementById('chatButtonContainer'); 
        const chatBox = document.getElementById('chatBox');
        const enterBtn = document.getElementById('enterBtn');
        const chatHeader = document.getElementById('chatHeader');
        const sendButton = document.getElementById('send');
        const mediaQuery = window.matchMedia('(max-width: 430px)'); //Î™®Î∞îÏùºÍ∑úÍ≤©
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('message');
        const inputBox = document.getElementById('inputBox');

        let myNickname = ''; // ÎÇ¥ ÎãâÎÑ§ÏûÑ Ï†ÄÏû• Î≥ÄÏàò
        let chatStarted = false; // Ï±ÑÌåÖ ÏãúÏûëÏÉÅÌÉú
        let isProcessing = false; // Ï§ëÎ≥µ ÏûÖÎ†• Î∞©ÏßÄÎ•º ÏúÑÌïú ÌîåÎûòÍ∑∏ Î≥ÄÏàò
        let sessionId = localStorage.getItem('sessionId');

        socket = io ({
            query: {
                sessionId,
            },
        });
        
        // Ï±ÑÌåÖÏ∞Ω UI Ï¥àÍ∏∞Ìôî
        function resetChatUI( forced = false ) {
            
            if (forced) {
                chatBox.style.display = 'none';
                chatButtonContainer.style.display = 'flex';
            }

            if (chatHeader) {
                chatHeader.textContent = '';
            }
            
            if (inputBox) {
                inputBox.style.visibility = 'hidden';
                inputBox.style.display = 'none';
            }
            
            if (messages && forced) {
                messages.innerHTML = '';
            }
            console.log('[client] Chat UI Î¶¨ÏÖã ÏÑ±Í≥µ');
        }

        // ÏÇ¨Ïö©ÏûêÍ∞Ä enter ÌÅ¥Î¶≠Ïãú Ï±ÑÌåÖÏ∞Ω ÌôîÎ©¥Ïóê ÎÇòÌÉÄÎÇ¥Í∏∞
         enterBtn.addEventListener('click', function() {
            if(!chatStarted) {
                chatBox.style.display = 'flex';
                chatButtonContainer.style.display = 'none';
                chatStarted = true;
                socket.emit('enter-state');
            }
        });

        // session Ïï°ÏÖò Ï≤òÎ¶¨
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('[client] Tab returned to foreground. Reset session.');
                socket.emit('session-action', 'reset');
            } else if (document.visibilityState === 'hidden') {
                console.log('[client] Tab moved to background.');
                socket.emit('session-action', 'background');
            }
        });

        // chat-notification
        const notificationBox = document.getElementById('notificationBox');
        setTimeout( ()=> {
            notificationBox.style.display ='none';
        }, 15500 ); 

        /* 
        * emoji 
        */
        const emojiBtn = document.getElementById('emoji-btn');
        const inputElement = document.getElementById('message');
        const pickerOptions = {
            onEmojiSelect: (emoji) => {
                //const input = document.getElementById('message'); 
                if(inputElement) {
                    inputElement.value += emoji.native;
                    inputElement.focus();
                } else {
                    console.error('<input> not found');
                }
            },
        };
        const picker = new EmojiMart.Picker(pickerOptions);
        picker.style.display = 'none';
        picker.style.position = 'absolute';
        picker.style.width = '360px';
        picker.style.maxHeight = '300px';
        picker.style.overflowX = 'hidden';
        picker.style.overflowY = 'auto';
        picker.style.zIndex = '9999';
        document.body.appendChild(picker);

        // Picker ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
        function updatePickerPosition() {
            const inputContainer = document.querySelector('.input-container');
            const inputRect = inputContainer.getBoundingClientRect();
            picker.style.top = `${window.scrollY + inputRect.top - picker.offsetHeight - 10}px`; // 10px Ïó¨Î∞±
            picker.style.left = `${inputRect.left + inputRect.width / 2 - picker.offsetWidth / 2}px`;
        }

        // Picker Ïà®Í∏∞Í∏∞ Ìï®Ïàò
        function hidePicker() {
            if (picker && picker.style.display === 'block') {
                picker.style.display = 'none';
            }
        }
        
        function togglePicker() {
            if (picker.style.display === 'none' || picker.style.display === '') {
                picker.style.display = 'block';
                updatePickerPosition();
            } else {
                hidePicker();
            }
        }

        // Ïù¥Î™®ÏßÄ ÌÅ¥Î¶≠Ïãú ÌÅ¥Î¶≠ÏúÑÏπòÏóê Ïò§Í≤å Ï≤òÎ¶¨
       emojiBtn.addEventListener('click', (event) => {
            if (picker.style.display === 'none' || picker.style.display === '') {
                picker.style.display = 'block';
                updatePickerPosition();
            } else {
                hidePicker();
            }
        });

        emojiBtn.addEventListener('touchstart', (evnet) => {
            event.preventDefault();
            togglePicker();
        }, { passive: false });

        
        // Îã§Î•∏ ÏòÅÏó≠ ÌÅ¥Î¶≠Ïãú Ïà®ÍπÄ Ï≤òÎ¶¨
        document.addEventListener('click', (event) => {
            const isClickInsidePicker = picker.contains(event.target);
            const isClickOnEmojiButton = emojiBtn.contains(event.target);
            if (!isClickInsidePicker && !isClickOnEmojiButton) {
                hidePicker();
            }
        });

        picker.addEventListener('click', (evnet) => {
            evnet.stopPropagation();
            console.log(`Selected emoji: ${emoji.native}`);
        });

        // send button
        function updateSendBtn(e) {
            if (e.matches) {
                sendButton.innerHTML = '<img src="images/sendBtn.png">';       
            } else {
                sendButton.textContent = 'send';
            }
        }
        updateSendBtn(mediaQuery);
        mediaQuery.addEventListener('change', updateSendBtn);

        /*
        *   Ï±ÑÌåÖ
        */ 
        chatBox.style.display = 'none';
        enterBtn.style.display = 'block';

        // ÏÑúÎ≤ÑÏóêÏÑú ÏÉàÎ°úÏö¥ ÏÑ∏ÏÖòid ÏàòÏã† 
        socket.on('session-id', (data) => {
            if (data.sessionId) {
                sessionId = data.sessionId;
                localStorage.setItem('sessionId', sessionId); // ÏÑ∏ÏÖò ID Ï†ÄÏû•
            }
        });

        // ÏÑúÎ≤ÑÏóêÏÑú ÎãâÎÑ§ÏûÑ Ï¥àÍ∏∞Ìôî Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
        socket.on('set-nickname', (nickname) => {
            myNickname = nickname;
            console.log(`[client] ÌòÑÏû¨ Ï†ëÏÜçÏûê: ${myNickname}`);
        });

        // max_report Ï¥àÍ≥º ÎåÄÏÉÅ Ï†ëÏÜç Î∂àÍ∞ÄÏ≤òÎ¶¨
        socket.on('report-redirect', (data) => {
            console.log(data.message);
            window.location.href = 'accessDenied.html';
        });

        //Ïã†Í≥†Ï≤òÎ¶¨
        socket.on('report-response', (data) => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('Ïã†Í≥† Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
            closeReportModal();
        });

        // Ï†ëÏÜç Ï∞®Îã® ÌöåÏõê Ï≤òÎ¶¨
        socket.on('connection-rejected', (data)=> {
            alert(data.message);
            window.location.href='accessDenied.html';
        });
        
        // session - expired
        socket.on('session-expired', (data) => {
            // ÏÑ∏ÏÖò ÎßåÎ£å Ïãú UI Ï¥àÍ∏∞Ìôî
            document.getElementById('chatBox').style.display = 'none';
            document.getElementById('chatButtonContainer').style.display = 'flex';
            document.getElementById('messages').innerHTML = '';

            setTimeout(() => {
                window.location.replace('chatPage.html');
                alert(data.message);
            }, 50);
        });

       // message Íµ¨Î∂Ñ
        function appendMessages(message, messageType) {
            const messageContainer = document.getElementById('messages');
            const newMessage = document.createElement('div');
            
            newMessage.className = messageType === 'system' ? 'system-message'
                                : messageType === 'sender' ? 'chat-message sender'
                                                            : 'chat-message receiver';
            newMessage.textContent = message;
            messageContainer.appendChild(newMessage);
            messageContainer.scrollTop = messageContainer.scrollHeight;

            if (messageType === 'sender') {
                messageInput.value = '';
            }
        };

        // sendÎ©îÏãúÏßÄ 
        function sendMessage(){
            const msg = messageInput.value.trim();
            if (msg) {
                socket.emit('chat-message', msg); // ÏÑúÎ≤ÑÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ°
                messageInput.value = '';
            }
        };

        // Î≤ÑÌäºÌÅ¥Î¶≠ ÎòêÎäî Enter ÏûÖÎ†•Ïãú Î©îÏãúÏßÄ Ï†ÑÏÜ°
        function handleSend(event) {
            if (event.type === 'click' || (event.type === 'keydown' && event.key === 'Enter')) {
                event.preventDefault(); // Í∏∞Î≥∏ ÎèôÏûë Î∞©ÏßÄ

                if (isProcessing) return; // Ï§ëÎ≥µ Ìò∏Ï∂ú Î∞©ÏßÄ
                isProcessing = true;
                sendMessage();

                // 30ms ÌõÑ ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî (Ï§ëÎ≥µ Î∞©ÏßÄ ÌÉÄÏù¥Î®∏)
                setTimeout(() => {
                    messageInput.value = '';
                    isProcessing = false;
                }, 30);
            }
        }

        // ÎåÄÍ∏∞Ï§ëÏù∏ Ïú†Ï†ÄÏóêÍ≤å ÏãúÏä§ÌÖú Î©îÏãúÏßÄ Ï†ÑÏÜ° 
        socket.on ('wait-state', (data) => {
            appendMessages(data.message , data.messageType);
        });

        // Ï±ÑÌåÖ Ï§ÄÎπÑ ÏôÑÎ£å Ïãú ÏÉÅÎåÄÎ∞© ÎãâÎÑ§ÏûÑ ÌëúÏãú
        socket.on('chat-ready', (data) => {
            // ÏÉÅÎåÄÎ∞© Ï†ïÎ≥¥ ÌëúÏãú
            partner = data.users.find(user => user.id !== socket.id);
            roomId= data.roomId;
            partnerNickname = partner.nickname;
            partnerIP = partner.userIP;

            const inputBox = document.getElementById('inputBox');
            if (inputBox) {
                inputBox.style.visibility = 'visible';
                inputBox.style.display = 'flex'; // ÏûÖÎ†•Ï∞Ω ÌôúÏÑ±Ìôî
            }
            
            chatHeader.textContent = "connected with: " + partner.nickname;
            // report Î≤ÑÌäº ÌôîÎ©¥Ïóê ÌëúÏãú
            const reportBtn = document.createElement('button');
            reportBtn.id = 'reportBtn';
            reportBtn.className = 'chat-header-btn';
            reportBtn.type = 'button';
            reportBtn.textContent = 'üö®'; // Î≤ÑÌäº ÎÇ¥Ïö©
            reportBtn.onclick = openReportModal; // ÌÅ¥Î¶≠ Ïãú Ïã†Í≥† Î™®Îã¨ Ïó¥Í∏∞
            chatHeader.appendChild(reportBtn);  // ÎãâÎÑ§ÏûÑ ÏòÜÏóê Î≤ÑÌäº Ï∂îÍ∞Ä

            appendMessages(data.message, data.messageType);
        });

        // Í≤ΩÍ≥† Î©îÏãúÏßÄ ÏàòÏã†
        socket.on('warning-message', (data) => {
            appendMessages(data.message, data.messageType);
        });

        // Î©îÏãúÏßÄ ÏàòÏã†
        socket.on('chat-message', (data) => {
            const isSender = data.sender === myNickname; 
            appendMessages(data.message, isSender ? 'sender' : 'receiver');
        });

        // Ï±ÑÌåÖ Ï¢ÖÎ£åÏãú Ï≤òÎ¶¨
        socket.on('chat-end', (data) => {
            appendMessages(data.message, 'system'); // ÏãúÏä§ÌÖú Î©îÏãúÏßÄÎ°ú ÏïåÎ¶º ÌëúÏãú
            
            if (data.isSelf) {
                resetChatUI(true);
            } else {
                if (chatHeader) {
                    chatHeader.textContent = ''; // ÎãâÎÑ§ÏûÑ Ï†úÍ±∞
                }
                if (inputBox) {
                    inputBox.style.visibility = 'hidden';
                    inputBox.style.display = 'none';
                }
            }
        });

        // ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï¢ÖÎ£å Í∞êÏßÄ
        socket.on('server-disconnect', () => {
            console.log('[client] ÏÑúÎ≤ÑÏôÄ Ïó∞Í≤∞Ïù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
            // ÏãúÏä§ÌÖú Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            appendMessages(data.message, 'system');
            resetChatUI(true);
        });

        // ÏÉÅÎåÄÎ∞©Ïùò ÏöîÏ≤≠ÏúºÎ°ú Ï±ÑÌåÖ Ï¢ÖÎ£å
        socket.on('user-disconnect', (data) => {
            appendMessages(data.message, 'system'); // ÏãúÏä§ÌÖú Î©îÏãúÏßÄÎ°ú ÏïåÎ¶º ÌëúÏãú
            
            if (data.isSelf) {
                resetChatUI(true);
            } else {
                if (chatHeader) {
                    chatHeader.textContent = ''; // ÎãâÎÑ§ÏûÑ Ï†úÍ±∞
                }
                if (inputBox) {
                    inputBox.style.visibility = 'hidden'; 
                    inputBox.style.display = 'none';
                }
            }
        });

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        sendButton.addEventListener('click', handleSend);
        messageInput.addEventListener('keydown', handleSend);

        // Ï±ÑÌåÖ Ï¢ÖÎ£å Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
        document.getElementById('exitBtn').addEventListener('click', () => {
            chatStarted=false;
            socket.emit('user-disconnect', { isSelf: true }); // ÏÑúÎ≤ÑÏóê Ï¢ÖÎ£å ÏöîÏ≤≠
            resetChatUI(true);
        });

        // Ïû¨Ïó∞Í≤∞ Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú 
        document.getElementById('restartBtn').addEventListener('click', () => {
            socket.emit('restart-connect');
            resetChatUI();
        });
    });
</script>
</body>
</html>